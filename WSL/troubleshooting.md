---
title: Устранение неполадок подсистемы Windows для Linux
description: Содержит подробные сведения о распространенных ошибках и проблемах, с которыми сталкиваются пользователи при выполнении Linux в подсистеме Windows для Linux.
keywords: BashOnWindows, bash, wsl, windows, windowssubsystem, ubuntu
ms.date: 01/20/2020
ms.topic: article
ms.localizationpriority: high
ms.openlocfilehash: 9028f1e89e92da94d82b16603b3af60876a4cb86
ms.sourcegitcommit: 8795e1c4c5d2efdc8a9c78af05fb7be3ac1eef3d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/13/2020
ms.locfileid: "79318148"
---
# <a name="troubleshooting-windows-subsystem-for-linux"></a>Устранение неполадок подсистемы Windows для Linux

Для получения поддержки по вопросам, связанным с WSL, см. наш репозиторий GitHub:

## <a name="search-for-any-existing-issues-related-to-your-problem"></a>Поиск описанных проблем, связанных с вашей проблемой

При возникновении технических проблем используйте репозиторий продуктов: https://github.com/Microsoft/wsl/issues

При возникновении проблем, связанных с содержимым этой документации, используйте репозиторий документов: https://github.com/MicrosoftDocs/wsl/issues

## <a name="submit-a-bug-report"></a>Отправка отчета об ошибке

При возникновении ошибок, связанных с функциями или компонентами WSL, отправьте сообщение о проблеме в репозитории продуктов: https://github.com/Microsoft/wsl/issues

## <a name="submit-a-feature-request"></a>Отправка запроса на добавление возможностей

Чтобы запросить новую возможность, связанную с функциональностью или совместимостью WSL, отправьте запрос в репозитории продуктов: https://github.com/Microsoft/wsl/issues

## <a name="contribute-to-the-docs"></a>Участие в разработке документации

Чтобы внести изменения в документацию по WSL, отправьте запрос на вытягивание в репозитории документов: https://github.com/MicrosoftDocs/wsl/issues

## <a name="terminal-or-command-line"></a>Терминал или командная строка

Наконец, если ваша проблема связана с терминалом Windows, консолью Windows или интерфейсом командной строки, используйте репозиторий терминалов Windows: https://github.com/microsoft/terminal

## <a name="common-issues"></a>Распространенные проблемы

### <a name="bash-loses-network-connectivity-once-connected-to-a-vpn"></a>Bash утрачивает подключение к сети после подключения к сети VPN

Если после подключения к VPN в Windows оболочка Bash утрачивает подключение к сети, попробуйте воспользоваться этим обходным решением в Bash. Это решение позволит вручную переопределить разрешение DNS с помощью `/etc/resolv.conf`.

1. Запишите DNS-сервер виртуальной частной сети. Для этого выполните `ipconfig.exe /all`
2. Создайте копию существующего resolv.conf, выполнив `sudo cp /etc/resolv.conf /etc/resolv.conf.new`
3. Разорвите связь с текущим файлом resolv.conf, выполнив команду `sudo unlink /etc/resolv.conf`.
4. `sudo mv /etc/resolv.conf.new /etc/resolv.conf`
5. Откройте `/etc/resolv.conf` и сделайте следующее. <br/>
   a. Удалите из файла первую строку с текстом "\# This file was automatically generated by WSL. To stop automatic generation of this file, remove this line." (Этот файл был автоматически создан WSL. Чтобы остановить автоматическое создание этого файла, удалите данную строку). <br/>
   b. Добавьте запись DNS из пункта 1 выше в качестве первой записи в списке DNS-серверов. <br/>
   c. Закройте файл. <br/>

После отключения VPN необходимо будет отменить изменения в `/etc/resolv.conf`. Для этого сделайте следующее.

1. `cd /etc`
2. `sudo mv resolv.conf resolv.conf.new`
3. `sudo ln -s ../run/resolvconf/resolv.conf resolv.conf`

### <a name="starting-wsl-or-installing-a-distribution-returns-an-error-code"></a>При запуске WSL или установке дистрибутива возвращается код ошибки

Выполните [эти инструкции](https://github.com/Microsoft/WSL/blob/master/CONTRIBUTING.md#8-detailed-logs), чтобы получить подробные журналы и сообщить о возникшей проблеме на портале GitHub.

### <a name="updating-bash-on-ubuntu-on-windows"></a>Обновление Bash для Ubuntu в Windows

Два компонента Bash для Ubuntu в Windows могут требовать обновления.

1. Подсистема Windows для Linux
  
   Обновление этой части Bash для Ubuntu в Windows обеспечит применение всех новых исправлений, описанных в [заметках о выпуске](./release-notes.md). Убедитесь, что вы подписаны на Программу предварительной оценки Windows и что ваша сборка обновлена. Чтобы обеспечить более точное управление, включая сброс экземпляра Ubuntu, ознакомьтесь со [страницей справочных материалов по командам](./reference.md).

2. Двоичные файлы пользователя Ubuntu

   При обновлении этой части Bash для Ubuntu в Windows будут установлены все обновления двоичных файлов пользователя Ubuntu, включая приложения, установленные с помощью apt-get. Чтобы выполнить обновление, выполните следующие команды в Bash.
  
   1. `apt-get update`
   2. `apt-get upgrade`
  
### <a name="apt-get-upgrade-errors"></a>Ошибки apt-get upgrade

Некоторые пакеты используют функции, которые еще не реализованы. Например, `udev`пока не поддерживается и вызывает несколько ошибок `apt-get upgrade`.

Чтобы устранить проблемы, связанные с `udev`, выполните следующие действия.

1. Введите приведенный ниже код в `/usr/sbin/policy-rc.d` и сохраните изменения.
  
   ```bash
   #!/bin/sh
   exit 101
   ```
  
2. Добавьте разрешения на выполнение в `/usr/sbin/policy-rc.d`:

   ```bash
   chmod +x /usr/sbin/policy-rc.d
   ```
  
3. Выполните следующие команды:

   ```bash
   dpkg-divert --local --rename --add /sbin/initctl
   ln -s /bin/true /sbin/initctl
   ```
  
### <a name="error-0x80040306-on-installation"></a>"Ошибка: 0x80040306" при установке

Это связано с тем, что мы не поддерживаем устаревшую консоль.
Чтобы отключить устаревшую консоль, выполните следующие действия.

1. Выполните файл cmd.exe.
1. Щелкните правой кнопкой мыши строку заголовка и выберите "Свойства", затем снимите флажок "Использовать прежнюю версию консоли".
1. Нажмите кнопку "ОК".

### <a name="error-0x80040154-after-windows-update"></a>"Ошибка: 0x80040154" после обновления Windows

Компонент "Подсистема Windows для Linux" может быть отключен во время обновления Windows. В этом случае данную функцию Windows необходимо включить заново. Инструкции по включению подсистемы Windows для Linux можно найти в [руководстве по установке](./install-win10.md).

### <a name="changing-the-display-language"></a>Изменение отображаемого языка

Установщик WSL попытается автоматически изменить языковой стандарт Ubuntu в соответствии с языковым стандартом установки Windows.  Если это нежелательно, можно выполнить приведенную ниже команду, чтобы изменить языковой стандарт Ubuntu после завершения установки.  Чтобы это изменение вступило в силу, потребуется повторно запустить bash.exe.

В приведенном ниже примере языковой стандарт изменяется на EN-US.

```bash
sudo update-locale LANG=en_US.UTF8
```

### <a name="installation-issues-after-windows-system-restore"></a>Проблемы установки после восстановления системы Windows

1. Удалите папку `%windir%\System32\Tasks\Microsoft\Windows\Windows Subsystem for Linux`. <br/>
  **Примечание. Не делайте этого, если дополнительный компонент полностью установлен и работает.**
2. Включите дополнительный компонент WSL (если он еще не включен).
3. Выполните перезагрузку.
4. Выполните команду lxrun /uninstall /full
5. Установите Bash.

### <a name="no-internet-access-in-wsl"></a>Нет доступа к Интернету в WSL

Некоторые пользователи сообщили о проблемах с определенными приложениями брандмауэра, блокирующими доступ к Интернету в WSL.  Сообщили о следующих брандмауэрах:

1. Kaspersky;
2. AVG;
3. Avast.

В некоторых случаях отключение брандмауэра обеспечивает доступ.  В некоторых случаях доступ блокируется просто при наличии установленного брандмауэра.

### <a name="permission-denied-error-when-using-ping"></a>Ошибка "Отказ в разрешении" при проверке связи

В выпуске [Windows Anniversary Update, версия 1607](./release-notes.md#build-14388-to-windows-10-anniversary-update) для проверки связи в WSL требуются **права администратора**.  Чтобы выполнить проверку связи, запустите Bash для Ubuntu в Windows от имени администратора или запустите bash.exe из командной строки или сеанса PowerShell с привилегиями администратора.

В более поздних версиях Windows ([сборка 14926+](./release-notes.md#build-14926)) права администратора не требуются.

### <a name="bash-is-hung"></a>Bash перестал отвечать на запросы

Если при работе с Bash вы обнаружите, что Bash перестал отвечать на запросы (или взаимозаблокирован), помогите нам диагностировать проблему путем сбора и передачи дампа памяти. Обратите внимание на то, что выполнение этих действий приведет к сбою системы. Не делайте этого, если вас это не устраивает, либо предварительно сохраните результаты своей работы.

Сбор дампа памяти

1. Измените тип дампа памяти на "Полный дамп памяти". При изменении типа дампа запишите текущий тип.

2. Выполните [эти действия](https://techcommunity.microsoft.com/t5/Core-Infrastructure-and-Security/How-to-Force-a-Diagnostic-Memory-Dump-When-a-Computer-Hangs/ba-p/257809), чтобы настроить аварийное завершение с помощью клавиатуры.

3. Воспроизведите взаимоблокировку или прекращение ответа на запросы.

4. Выполните аварийное завершение системы с помощью последовательности клавиш из пункта 2.

5. Произойдет аварийное завершение системы и будет собран дамп памяти.

6. После перезагрузки системы отправьте memory.dmp на адрес электронной почты secure@microsoft.com. По умолчанию файл дампа находится в папке %SystemRoot%\memory.dmp или C:\Windows\memory.dmp, если C: является системным диском. В письме укажите, что дамп предназначен для команды разработчиков WSL или Bash в Windows.

7. Восстановите исходное значение типа дампа памяти.

### <a name="check-your-build-number"></a>Проверка номера сборки

Чтобы узнать архитектуру компьютера и номер сборки Windows, выберите  
**Параметры** > **Система** > **О программе**

Найдите поля **Сборка ОС** и **Тип системы**.  
    ![Снимок экрана с полями "Сборка ОС" и "Тип системы"](media/system.png)

Чтобы найти номер сборки Windows Server, выполните в PowerShell следующую команду.  

``` PowerShell
systeminfo | Select-String "^OS Name","^OS Version"
```

### <a name="confirm-wsl-is-enabled"></a>Подтверждение включения WSL

Вы можете убедиться, что подсистема Windows для Linux включена, выполнив в PowerShell следующую команду.  

``` PowerShell
Get-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux
```

### <a name="openssh-server-connection-issues"></a>Проблемы с подключением к серверу OpenSSH

Попытка подключения к серверу SSH завершается следующей ошибкой: "Connection closed by 127.0.0.1 port 22" (Подключение закрыто узлом 127.0.0.1 через порт 22).

1. Убедитесь, что сервер OpenSSH работает

   ```bash
   sudo service ssh status
   ```

   и вы следовали указаниям в этом руководстве: https://help.ubuntu.com/lts/serverguide/openssh-server.html.en.

2. Завершите работу службы sshd и запустите sshd в режиме отладки.

   ```bash
   sudo service ssh stop
   sudo /usr/sbin/sshd -d
   ```

3. Проверьте журналы запуска и убедитесь, что ключи сервера доступны и в журнале нет сообщений, как показано ниже.

   ```BASH
   debug1: sshd version OpenSSH_7.2, OpenSSL 1.0.2g  1 Mar 2016
   debug1: key_load_private: incorrect passphrase supplied to decrypt private key
   debug1: key_load_public: No such file or directory
   Could not load host key: /etc/ssh/ssh_host_rsa_key
   debug1: key_load_private: No such file or directory
   debug1: key_load_public: No such file or directory
   Could not load host key: /etc/ssh/ssh_host_dsa_key
   debug1: key_load_private: No such file or directory
   debug1: key_load_public: No such file or directory
   Could not load host key: /etc/ssh/ssh_host_ecdsa_key
   debug1: key_load_private: No such file or directory
   debug1: key_load_public: No such file or directory
   Could not load host key: /etc/ssh/ssh_host_ed25519_key
   ```

Если вы видите такие сообщения и в разделе `/etc/ssh/` отсутствуют ключи, потребуется повторно создать ключи или просто очистить и установить сервер OpenSSH.

```BASH
sudo apt-get purge openssh-server
sudo apt-get install openssh-server
```

### <a name="the-referenced-assembly-could-not-be-found-when-enabling-the-wsl-optional-feature"></a>"Указанная сборка не найдена". Это сообщение может появиться при включении дополнительного компонента WSL.

Данная ошибка связана с неправильным состоянием установки. Чтобы устранить эту проблему, выполните следующие действия.

- Если вы используете команду включения компонента WSL в PowerShell, попробуйте использовать графический пользовательский интерфейс. Для этого откройте меню "Пуск", выполните поиск фразы "Включение или отключение компонентов Windows", а затем из списка выберите "Подсистема Windows для Linux". Этот дополнительный компонент будет установлен.

- Обновите версию Windows, выбрав "Параметры" > "Обновления" и щелкнув "Проверить наличие обновлений".

- Если оба способа не помогли и вам нужно использовать WSL, рассмотрите возможность обновления на месте, переустановив Windows 10 с установочного носителя и выбрав параметр "Сохранить все", чтобы сохранить свои приложения и файлы. Инструкции по такой установке можно найти на странице [Переустановка Windows 10](https://support.microsoft.com/help/4000735/windows-10-reinstall).

### <a name="correct-ssh-related-permission-errors"></a>Правильные (связанные с SSH) ошибки разрешений

Если вы видите эту ошибку:

```
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@         WARNING: UNPROTECTED PRIVATE KEY FILE!          @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
Permissions 0777 for '/home/artur/.ssh/private-key.pem' are too open.
```

Чтобы устранить эту проблему, добавьте следующий текст в файл ```/etc/wsl.conf```:

```
[automount]
enabled = true
options = metadata,uid=1000,gid=1000,umask=0022
```

Обратите внимание, что добавление этой команды будет включать метаданные и изменять разрешения для файлов Windows, показанных в WSL. См. сведения о [разрешениях файловой системы](./file-permissions.md).
